if(fpcm===void 0)var fpcm={};fpcm.import={init:function(){fpcm.ui.selectmenu("#import_destination",{change:function(e,t){if(fpcm.dom.fromId("fpcm-ui-csv-fields-select").empty(),fpcm.dom.fromId("fpcm-ui-csv-fields-list").empty(),!fpcm.vars.jsvars.fields[t.value.replace(/\\/g,"_")])return!1;let n=fpcm.vars.jsvars.fields[t.value.replace(/\\/g,"_")],o=0;for(var s in n)o++,fpcm.dom.appendHtml("#fpcm-ui-csv-fields-select",'<li class="list-group-item" id="csv_field_'+n[s]+'" draggable="true" data-index="'+o+'" data-fname="'+n[s]+'">'+fpcm.ui.translate(s)+"</li>");return fpcm.import._initDnd("fpcm-ui-csv-fields-list"),fpcm.import._initDnd("fpcm-ui-csv-fields-select"),!1}}),fpcm.dom.bindClick("#btnImportReset",function(){fpcm.import._exec({csv:{file:fpcm.dom.fromId("import_filename").val()},reset:!0,unique:fpcm.vars.jsvars.unique}),fpcm.worker.postMessage({cmd:"remove",id:"import.exec"})}),fpcm.dom.bindClick("#btnImportPreview",function(){if(!fpcm.import._checkPreconditions())return!1;fpcm.worker.postMessage({namespace:"import",function:"_exec",id:"import.exec",param:{csv:{item:fpcm.import._getImportDestinationValue(),file:fpcm.dom.fromId("import_filename").val(),delim:fpcm.dom.fromId("import_delimiter").val(),enclo:fpcm.dom.fromId("import_enclosure").val(),skipfirst:fpcm.dom.fromId("import_first").prop("checked"),fields:fpcm.import._getFields()},start:!0,preview:!0,unique:fpcm.vars.jsvars.unique,current:1,next:1}})}),fpcm.dom.bindClick("#btnImportStart",function(){if(!fpcm.import._checkPreconditions())return!1;fpcm.dom.fromId("fpcm-id-progress-col").removeClass("d-none"),fpcm.ui_dialogs.confirm({clickYes:function(){fpcm.worker.postMessage({namespace:"import",function:"_exec",id:"import.exec",param:{csv:{item:fpcm.import._getImportDestinationValue(),file:fpcm.dom.fromId("import_filename").val(),delim:fpcm.dom.fromId("import_delimiter").val(),enclo:fpcm.dom.fromId("import_enclosure").val(),skipfirst:fpcm.dom.fromId("import_first").prop("checked"),fields:fpcm.import._getFields()},start:!0,unique:fpcm.vars.jsvars.unique,current:1,next:1}})}})})},_exec:function(e){if(e.start&&!e.csv.file)return fpcm.ui.addMessage({type:"error",txt:"IMPORT_MSG_NOFILE"}),!1;fpcm.ajax.post("import",{data:e,cache:!1,quiet:!0,dataType:"json",execDone:function(e){if(e.reset!==void 0)return fpcm.worker.postMessage({cmd:"remove",id:"import.exec"}),fpcm.ui.relocate("self"),!1;if(!e.data)return fpcm.ui.progressbar("csvimport",{max:1,value:1}),fpcm.ui.addMessage(e,!0),fpcm.worker.postMessage({cmd:"remove",id:"import.exec"}),!1;if(e.data.previews)return fpcm.worker.postMessage({cmd:"remove",id:"import.exec"}),fpcm.import._showPreviewDialog(e.data),!1;if(fpcm.ui.progressbar("csvimport",{max:e.data.fs,value:e.current?e.current:e.data.fs,animated:!0}),!e.next)return fpcm.worker.postMessage({cmd:"remove",id:"import.exec"}),fpcm.ui.addMessage({txt:"IMPORT_MSG_FINISHED",type:"notice"}),!1;fpcm.import._exec({current:e.current,next:e.next,unique:e.unique})},execFailed:function(){fpcm.worker.postMessage({cmd:"remove",id:"import.exec"})}})},_checkPreconditions:function(){return fpcm.dom.fromId("import_filename").val()?!!fpcm.import._getFields().length||(fpcm.ui.addMessage({type:"error",txt:"IMPORT_MSG_NOFIELDS"}),!1):(fpcm.ui.addMessage({type:"error",txt:"IMPORT_MSG_NOFILE"}),!1)},_showPreviewDialog:function(e){let t=[],o=[];t.push('<div class="row mx-0 px-0">');for(i in e.previews[0])t.push('<div class="col"><strong>'+fpcm.ui.translate(i)+"</strong></div>"),o.push(e.previews[0][i]);t.push("</div>");for(var s,i,n=1;n<e.previews.length;n++){if(e.previews[n]===void 0)continue;t.push('<div class="row mx-0 my-1 px-0">');for(s=0;s<o.length;s++)t.push('<div class="col">'+e.previews[n][o[s]]+"</div>");t.push("</div>")}return t=t.join(`
`),fpcm.ui_dialogs.create({title:"GLOBAL_PREVIEW",dialogId:"csv-import-preview",content:t,closeButton:!0,size:"xl"}),!1},_getFields:function(){let e=fpcm.dom.fromId("fpcm-ui-csv-fields-list").find("li"),t=[];if(!e.length)return fpcm.ui.addMessage({type:"error",txt:"IMPORT_MSG_INVALIDIMPORTTYPE_NONE"}),t;for(var n=0;n<e.length;n++)t.push(e[n].dataset.fname);return t},_initDnd:function(e){fpcm.ui_dnd.initDnd({destination:e,group:"shared"})},_getImportDestinationValue:function(){return fpcm.dom.fromId("import_destination").val().replace(/\\/g,"__")}},fpcm.filemanager={runFileIndexUpdate:function(e){if(e===void 0)return!1;let t="";if(e.uploadID&&e.successful&&e.successful[0]&&e.successful[0].name)t=e.successful[0].name;else if(e.files&&e.files[0]&&e.files[0].name)t=e.files[0].name;else return!1;return fpcm.dom.fromId("fileupload").addClass("fpcm ui-hidden"),fpcm.dom.appendHtml("#fpcm-ui-csv-upload",'<div class="row my-2">'+fpcm.ui.getTextInput({name:"import_filename",id:"import_filename",value:t,text:fpcm.ui.translate("IMPORT_FILE")})+"</div>"),fpcm.dom.isReadonly("#import_filename",!0),!1},getAcceptTypes:function(){return/(\.|\/)(csv)$/i},getAcceptTypesArr:function(){return["csv","text/csv"]}}