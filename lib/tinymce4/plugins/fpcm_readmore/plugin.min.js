tinymce.PluginManager.add('fpcm_readmore', function(editor, url) {
    editor.addButton('fpcm_readmore', {
        icon: "fpcm-readmore",
        tooltip: fpcmTinyMceReadmoreBlockHL,
        onclick: function() {
            editor.windowManager.open({
                title: fpcmTinyMceReadmoreBlockHL,
                body: [
                    {
                        type: 'textbox',
                        name: 'fpcm-ui-readmoretext-tinymce',
                        id: 'fpcm-ui-readmoretext-tinymce',
                        multiline: true,
                        minWidth: editor.getParam("code_dialog_width", 600),
                        minHeight: editor.getParam("code_dialog_height", Math.min(tinymce.DOM.getViewPort().h - 200, 500)),
                        style: 'direction: ltr; text-align: left',
                    }
                ],               
                onsubmit: function() {
                    var text = jQuery('#fpcm-ui-readmoretext-tinymce').val();
                    if (!text) return;
                    
                    var htmlChk = text.search(/^(<\/?[\w\s="/.':;#-\/\?]+>)/i);
                    if (htmlChk === -1) text = '<p>' + text + '</p>';
                    editor.insertContent('<readmore>' + text + '</readmore>');
                }
            });
        }
    });
});